name: CI Workflow for CAPTCHA Solving Python Script

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-script:
    runs-on: windows-latest
    env:
      TWO_CAPTCHA_API_KEY: ${{ secrets.TWO_CAPTCHA_API_KEY }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
      VPN_USERNAME: ${{ secrets.VPN_USERNAME }}
      VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
      VPN_FOLDER_PATH: ${{ secrets.VPN_FOLDER_PATH }}

    steps:
    # Step 1: Set up Python 3.12
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    # Step 2: Check out the repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # Step 3: Debug Environment Variables
    - name: Debug Environment Variables
      shell: pwsh
      run: |
        Write-Output "[DEBUG] Dumping all environment variables..."
        Get-ChildItem Env: | Sort-Object Name

    # Step 4: Debug Individual Secrets
    - name: Debug Individual Secrets
      shell: pwsh
      run: |
        Write-Output "[DEBUG] GOOGLE_CREDENTIALS_JSON: $env:GOOGLE_CREDENTIALS_JSON"
        Write-Output "[DEBUG] GOOGLE_TOKEN_JSON: $env:GOOGLE_TOKEN_JSON"
        Write-Output "[DEBUG] VPN_USERNAME: $env:VPN_USERNAME"
        Write-Output "[DEBUG] VPN_PASSWORD: $env:VPN_PASSWORD"
        Write-Output "[DEBUG] VPN_FOLDER_PATH: $env:VPN_FOLDER_PATH"

    # Step 5: Validate Environment Variables
    - name: Validate Environment Variables
      shell: pwsh
      run: |
        Write-Output "[INFO] Validating required environment variables..."
        if (-not $env:TWO_CAPTCHA_API_KEY) {
            Write-Output "[!] TWO_CAPTCHA_API_KEY is missing."
            exit 1
        }
        if (-not $env:VPN_USERNAME) {
            Write-Output "[!] VPN_USERNAME is missing."
            exit 1
        }
        if (-not $env:VPN_PASSWORD) {
            Write-Output "[!] VPN_PASSWORD is missing."
            exit 1
        }
        if (-not $env:GOOGLE_CREDENTIALS_JSON) {
            Write-Output "[!] GOOGLE_CREDENTIALS_JSON is missing."
            exit 1
        }
        if (-not $env:GOOGLE_TOKEN_JSON) {
            Write-Output "[!] GOOGLE_TOKEN_JSON is missing."
            exit 1
        }
        if (-not $env:VPN_FOLDER_PATH) {
            Write-Output "[!] VPN_FOLDER_PATH is missing."
            exit 1
        }
        Write-Output "[âœ“] All required environment variables are validated."

    # Step 6: Run CAPTCHA Solving Script
    - name: Run CAPTCHA Solving Script
      run: python "Skip Tracing\\truppl_parser.py"
