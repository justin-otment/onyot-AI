name: CI Workflow for Skip Tracing Python Scripts

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-script:
    runs-on: windows-latest
  env: production

    steps:
    # Step 1: Set up Python 3.12
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    # Step 2: Check out the repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # Step 3: Display Requirements File
    - name: Display Requirements File
      run: type requirements.txt

    # Step 4: Upgrade pip, setuptools, and wheel
    - name: Upgrade pip, setuptools, and wheel
      run: |
        python -m pip install --upgrade pip setuptools wheel

    # Step 5: Install Python Dependencies
    - name: Install Python Dependencies
      run: pip install -r requirements.txt

    # Step 6: Install Playwright Browsers
    - name: Install Playwright Browsers
      run: python -m playwright install

    # Step 7: Debug Environment Variables
    - name: Debug Environment Variables
      run: |
        echo GOOGLE_CREDENTIALS_JSON=%GOOGLE_CREDENTIALS_JSON%
        echo GOOGLE_TOKEN_JSON=%GOOGLE_TOKEN_JSON%
        echo TWO_CAPTCHA_API_KEY=%TWO_CAPTCHA_API_KEY%
        echo VPN_USERNAME=%VPN_USERNAME%
        echo VPN_PASSWORD=%VPN_PASSWORD%
        echo VPN_FOLDER_PATH=%VPN_FOLDER_PATH%

        # Step: Validate Environment Variables
    - name: Validate Environment Variables
      shell: pwsh
      run: |
        if (-not $env:TWO_CAPTCHA_API_KEY) {
            Write-Output "[!] TWO_CAPTCHA_API_KEY is missing."
            exit 1
        }
        if (-not $env:VPN_USERNAME) {
            Write-Output "[!] VPN_USERNAME is missing."
            exit 1
        }
        if (-not $env:VPN_PASSWORD) {
            Write-Output "[!] VPN_PASSWORD is missing."
            exit 1
        }

    # Step 9: Set Environment Variables
    - name: Set Environment Variables
      run: echo "Environment variables set"
      env:
        GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        TWO_CAPTCHA_API_KEY: ${{ secrets.TWO_CAPTCHA_API_KEY }}
        VPN_USERNAME: ${{ secrets.VPN_USERNAME }}
        VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
        VPN_FOLDER_PATH: ${{ secrets.VPN_FOLDER_PATH }}

    # Step 10: Run Truppl Parser Script
    - name: Run Truppl Parser Script
      run: python "Skip Tracing\\truppl_parser.py"
