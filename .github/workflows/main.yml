name: Run Skip Tracing Parser

on:
  workflow_dispatch:
  push:
    paths:
      - 'Skip Tracing/**'
      - '.github/workflows/main.yml'

jobs:
  run-parser:
    runs-on: windows-latest  # Keep Windows as CI runner

    env:
      PYTHONIOENCODING: utf-8
      TWO_CAPTCHA_API_KEY: ${{ secrets.TWO_CAPTCHA_API_KEY }}
      VPN_USERNAME: ${{ secrets.VPN_USERNAME }}
      VPN_PASSWORD: ${{ secrets.VPN_PASSWORD }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Anaconda (Miniconda)
        run: |
          Invoke-WebRequest -Uri "https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe" -OutFile "Miniconda.exe"
          Start-Process -FilePath "Miniconda.exe" -ArgumentList "/S /D=C:\Miniconda" -Wait

      - name: Set up Conda Python 3.12.8
        run: |
          C:\Miniconda\Scripts\conda.exe init powershell
          echo "C:\Miniconda\Scripts\conda.exe activate automation_env" >> $env:GITHUB_PATH
          C:\Miniconda\Scripts\conda.exe create --name automation_env python=3.12.8 -y
          C:\Miniconda\Scripts\activate automation_env

      - name: Verify Python Version
        run: python --version

      - name: Install dependencies
        run: |
          C:\Miniconda\Scripts\conda.exe install --name automation_env --file requirements.txt -y

      - name: Install Playwright Browsers
        run: |
          npx playwright install --with-deps
          chmod -R 777 ~/.cache/ms-playwright  # Fix permissions

      - name: Run Skip Tracing Parser
        run: python "Skip Tracing/truppl_parser.py"
