name: Run Multiple Python Scripts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  rapid-api-script:
    runs-on: windows-latest
    strategy:
      matrix:
        script:
          - "rapid_API.py"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set Python UTF-8 Encoding
        run: echo "PYTHONIOENCODING=UTF-8" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }
          python -m pip install nest_asyncio
        shell: powershell

      - name: Install Firefox and Geckodriver
        run: |
          choco install firefox -y
          $response = Invoke-WebRequest -Uri "https://api.github.com/repos/mozilla/geckodriver/releases/latest" | ConvertFrom-Json
          $GECKO_VERSION = $response.tag_name -replace "v", ""
          $GECKO_URL = "https://github.com/mozilla/geckodriver/releases/download/v$GECKO_VERSION/geckodriver-v$GECKO_VERSION-win64.zip"
          Invoke-WebRequest -Uri $GECKO_URL -OutFile geckodriver.zip
          Expand-Archive geckodriver.zip -DestinationPath C:\GeckoDriver
          $env:PATH += ";C:\GeckoDriver"
          C:\GeckoDriver\geckodriver.exe --version
        shell: powershell

      - name: Verify credentials existence
        run: |
          if (!(Test-Path "Skip Tracing\credentials.json") -or !(Test-Path "Skip Tracing\token.json")) {
            Write-Output "Credential files missing! Ensure they exist in the project root."
            exit 1
          }
        shell: powershell

      - name: Set environment variables
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=Skip Tracing\credentials.json" | Out-File -Encoding utf8 -Append $env:GITHUB_ENV
          echo "TOKEN_PATH=Skip Tracing\token.json" | Out-File -Encoding utf8 -Append $env:GITHUB_ENV
        shell: powershell

      - name: Verify script location
        run: Get-ChildItem -Path "Skip Tracing" -Recurse
        shell: powershell

      - name: Run Python script
        run: python "Skip Tracing/truppl_parser.py"

  run-script-1:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }
        shell: powershell

      - name: Install Firefox and Geckodriver
        run: |
          choco install firefox -y
          $response = Invoke-WebRequest -Uri "https://api.github.com/repos/mozilla/geckodriver/releases/latest" | ConvertFrom-Json
          $GECKO_VERSION = $response.tag_name -replace "v", ""
          $GECKO_URL = "https://github.com/mozilla/geckodriver/releases/download/v$GECKO_VERSION/geckodriver-v$GECKO_VERSION-win64.zip"
          Invoke-WebRequest -Uri $GECKO_URL -OutFile geckodriver.zip
          Expand-Archive geckodriver.zip -DestinationPath C:\GeckoDriver
          $env:PATH += ";C:\GeckoDriver"
          C:\GeckoDriver\geckodriver.exe --version
        shell: powershell

      - name: Verify script location
        run: Get-ChildItem -Path "Skip Tracing" -Recurse
        shell: powershell

      - name: Run Python script
        env:
          GOOGLE_APPLICATION_CREDENTIALS: Skip Tracing\credentials.json
          TOKEN_PATH: Skip Tracing\token.json
        run: python "Skip Tracing/truppl_parser.py"
